#!/bin/bash

# Function to find Nessus Agent binary location
find_nessus_agent() {
    # Common Unix/Mac installation paths
    local paths=(
        "/opt/nessus_agent/sbin/nessuscli"
        "/Library/NessusAgent/run/sbin/nessuscli"
    )
    
    for path in "${paths[@]}"; do
        if [ -f "$path" ]; then
            echo "$path"
            return 0
        fi
    done
    
    # If not found in common paths, try to find it
    local search_paths=("/opt" "/Library" "/Applications")
    for search_path in "${search_paths[@]}"; do
        if [ -d "$search_path" ]; then
            local found_path=$(find "$search_path" -name "nessuscli" 2>/dev/null | grep -i "nessus.*agent" | head -n 1)
            if [ -n "$found_path" ]; then
                echo "$found_path"
                return 0
            fi
        fi
    done
    
    return 1
}

# Function to check if script is running with sufficient privileges
check_root() {
    if [ "$(id -u)" != "0" ]; then
        echo "Error: This script must be run with root privileges"
        exit 1
    fi
}

# Function to get linking key from user
get_linking_key() {
    LINKING_KEY=${LINKING_KEY:-""}
    
    # Prompt for linking key if not provided
    while [ -z "$LINKING_KEY" ]; do
        echo -n "Enter your Tenable.io linking key: "
        read -r LINKING_KEY
        if [ -z "$LINKING_KEY" ]; then
            echo "Linking key cannot be empty. Please try again."
        fi
    done
}

# Main script
main() {
    # Check for root privileges
    check_root
    
    # Set Tenable.io default connection details
    SERVER="cloud.tenable.com"
    PORT="443"
    
    echo "Searching for Nessus Agent installation..."
    NESSUSCLI=$(find_nessus_agent)
    
    if [ $? -ne 0 ] || [ -z "$NESSUSCLI" ]; then
        echo "Error: Could not find Nessus Agent installation"
        echo "Please ensure Nessus Agent is installed in one of these locations:"
        echo "  - /opt/nessus_agent/sbin/nessuscli"
        echo "  - /Library/NessusAgent/run/sbin/nessuscli"
        exit 1
    fi
    
    echo "Found Nessus Agent at: $NESSUSCLI"
    
    # Verify nessuscli is executable
    if [ ! -x "$NESSUSCLI" ]; then
        echo "Error: $NESSUSCLI is not executable"
        exit 1
    fi
    
    # Get linking key from user
    get_linking_key
    
    # Unlink existing agent if already linked
    echo "Checking current agent status..."
    if "$NESSUSCLI" agent status | grep -q "linked"; then
        echo "Unlinking existing agent configuration..."
        "$NESSUSCLI" agent unlink
    fi
    
    # Link the agent to Tenable.io
    echo "Linking agent to Tenable.io..."
    if ! "$NESSUSCLI" agent link --key="$LINKING_KEY" --host="$SERVER" --port="$PORT"; then
        echo "Error: Failed to link Nessus Agent"
        exit 1
    fi
    
    echo "Successfully linked Nessus Agent to Tenable.io"
    echo "Current agent status:"
    "$NESSUSCLI" agent status
}

# Run main function
main
