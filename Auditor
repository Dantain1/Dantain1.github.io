# System Configuration Assessment Tool
# Purpose: Audit key system security configurations and generate a report

# Enable debug logging
$DebugPreference = "Continue"
$ErrorActionPreference = "Stop"
$LogFile = ".\SecurityAudit_Debug_$(Get-Date -Format 'yyyyMMddHHmmss').log"

function Write-DebugLog {
    param(
        [string]$Message,
        [string]$Type = "INFO"  # INFO, ERROR, WARNING
    )
    
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Type] $Message"
    Add-Content -Path $LogFile -Value $logMessage
    
    switch ($Type) {
        "ERROR" { Write-Host $logMessage -ForegroundColor Red }
        "WARNING" { Write-Host $logMessage -ForegroundColor Yellow }
        default { Write-Host $logMessage -ForegroundColor Gray }
    }
}

function Test-AdminPrivileges {
    $currentUser = [Security.Principal.WindowsIdentity]::GetCurrent()
    $windowsPrincipal = New-Object Security.Principal.WindowsPrincipal($currentUser)
    return $windowsPrincipal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

function Get-SystemSecurityAudit {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$false)]
        [string]$ComputerName = $env:COMPUTERNAME,
        
        [Parameter(Mandatory=$false)]
        [string]$ReportPath = ".\SecurityAudit_$(Get-Date -Format 'yyyyMMdd').txt"
    )

    Write-DebugLog "Starting security audit for $ComputerName"
    $results = @()
    
    # Check Windows Firewall Status
    Write-DebugLog "Checking firewall status..."
    $firewallCheck = @{
        Category = "Windows Firewall"
        Test = "Firewall Status"
        Status = $null
        Details = $null
    }
    
    try {
        $firewall = Get-NetFirewallProfile
        $firewallCheck.Status = "Checked"
        $firewallCheck.Details = ($firewall | ForEach-Object { "$($_.Name): $($_.Enabled)" }) -join "; "
    }
    catch {
        Write-DebugLog "Error checking firewall: $($_.Exception.Message)" "ERROR"
        $firewallCheck.Status = "Error"
        $firewallCheck.Details = $_.Exception.Message
    }
    $results += [PSCustomObject]$firewallCheck

    # Check Account Policies
    Write-DebugLog "Checking account policies..."
    $accountPolicies = @{
        Category = "Account Policies"
        Test = "Password Policy"
        Status = $null
        Details = $null
    }
    
    try {
        $netAccounts = net accounts
        $accountPolicies.Status = "Checked"
        $accountPolicies.Details = ($netAccounts | Select-String "Password") -join "; "
    }
    catch {
        Write-DebugLog "Error checking account policies: $($_.Exception.Message)" "ERROR"
        $accountPolicies.Status = "Error"
        $accountPolicies.Details = $_.Exception.Message
    }
    $results += [PSCustomObject]$accountPolicies

    # Check Windows Updates
    Write-DebugLog "Checking Windows updates..."
    $updateCheck = @{
        Category = "Windows Updates"
        Test = "Update Status"
        Status = $null
        Details = $null
    }
    
    try {
        $updates = Get-HotFix | Sort-Object -Property InstalledOn -Descending | Select-Object -First 5
        $updateCheck.Status = "Checked"
        $updateCheck.Details = "Last 5 updates: " + ($updates | ForEach-Object { "$($_.HotFixID) ($($_.InstalledOn))" }) -join "; "
    }
    catch {
        Write-DebugLog "Error checking Windows updates: $($_.Exception.Message)" "ERROR"
        $updateCheck.Status = "Error"
        $updateCheck.Details = $_.Exception.Message
    }
    $results += [PSCustomObject]$updateCheck

    # Check Running Services
    Write-DebugLog "Checking critical services..."
    $serviceCheck = @{
        Category = "Services"
        Test = "Critical Services"
        Status = $null
        Details = $null
    }
    
    try {
        $criticalServices = Get-Service -Name "WinDefend", "wscsvc", "SecurityHealthService" -ErrorAction SilentlyContinue |
            Select-Object Name, Status
        $serviceCheck.Status = "Checked"
        $serviceCheck.Details = ($criticalServices | ForEach-Object { "$($_.Name): $($_.Status)" }) -join "; "
    }
    catch {
        Write-DebugLog "Error checking services: $($_.Exception.Message)" "ERROR"
        $serviceCheck.Status = "Error"
        $serviceCheck.Details = $_.Exception.Message
    }
    $results += [PSCustomObject]$serviceCheck

    # Generate Report
    Write-DebugLog "Generating report..."
    $report = @"
System Security Audit Report
Computer Name: $ComputerName
Date: $(Get-Date)
----------------------------------------

"@

    foreach ($result in $results) {
        $report += @"
Category: $($result.Category)
Test: $($result.Test)
Status: $($result.Status)
Details: $($result.Details)
----------------------------------------

"@
    }

    # Save report
    try {
        $report | Out-File -FilePath $ReportPath -Force
        Write-DebugLog "Report saved to $ReportPath"
    }
    catch {
        Write-DebugLog "Error saving report: $($_.Exception.Message)" "ERROR"
    }
    
    return $results | Format-Table -AutoSize
}

# Function to check specific security settings
function Get-SecuritySettings {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$false)]
        [string]$ComputerName = $env:COMPUTERNAME
    )
    
    Write-DebugLog "Checking security settings for $ComputerName..."
    
    $settings = @{}
    
    try {
        $settings.SMBv1 = (Get-WindowsOptionalFeature -Online -FeatureName SMB1Protocol).State
        $settings.PowerShellVersion = $PSVersionTable.PSVersion
        $settings.ExecutionPolicy = Get-ExecutionPolicy
        $settings.BitLockerStatus = (Get-BitLockerVolume -ErrorAction SilentlyContinue).ProtectionStatus
        $settings.DefenderStatus = (Get-MpComputerStatus).AntivirusEnabled
    }
    catch {
        Write-DebugLog "Error checking security settings: $($_.Exception.Message)" "ERROR"
    }
    
    return [PSCustomObject]$settings | Format-List
}

# Main execution block
Write-Host "`n=== System Security Audit Tool ===" -ForegroundColor Cyan
Write-Host "This script will perform a security audit of your system." -ForegroundColor Yellow
Write-Host "Debug logs will be written to: $LogFile" -ForegroundColor Gray

# Check for admin privileges
if (-not (Test-AdminPrivileges)) {
    Write-Host "`nWARNING: This script requires administrative privileges to perform a complete audit." -ForegroundColor Red
    Write-Host "Please run PowerShell as Administrator.`n" -ForegroundColor Red
    exit
}

# Prompt for confirmation
$confirmation = Read-Host "`nDo you want to proceed with the security audit? (Y/N)"
if ($confirmation -ne 'Y') {
    Write-Host "`nAudit cancelled by user. Exiting...`n" -ForegroundColor Yellow
    exit
}

try {
    Write-Host "`nStarting security audit..." -ForegroundColor Green
    Write-Host "Running Get-SystemSecurityAudit..." -ForegroundColor Cyan
    Get-SystemSecurityAudit

    Write-Host "`nRunning Get-SecuritySettings..." -ForegroundColor Cyan
    Get-SecuritySettings
    
    Write-Host "`nAudit completed successfully!" -ForegroundColor Green
    Write-Host "Debug log saved to: $LogFile" -ForegroundColor Gray
}
catch {
    Write-DebugLog "Critical error during audit: $($_.Exception.Message)" "ERROR"
    Write-Host "`nAn error occurred during the audit. Please check the debug log for details." -ForegroundColor Red
    Write-Host "Debug log location: $LogFile" -ForegroundColor Gray
}
finally {
    Write-Host "`nScript execution completed.`n" -ForegroundColor Cyan
}
