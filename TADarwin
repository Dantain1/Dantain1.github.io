#!/bin/bash

# Function to find Nessus Agent binary location
find_nessus_agent() {
    # Common Unix/Mac installation paths
    local paths=(
        "/opt/nessus_agent/sbin/nessuscli"
        "/Library/NessusAgent/run/sbin/nessuscli"
    )
    
    for path in "${paths[@]}"; do
        if [ -f "$path" ]; then
            echo "$path"
            return 0
        fi
    done
    
    # If not found in common paths, try to find it
    # Restrict find to specific directories to improve performance and reduce errors
    local search_paths=("/opt" "/Library" "/Applications")
    for search_path in "${search_paths[@]}"; do
        if [ -d "$search_path" ]; then
            local found_path=$(find "$search_path" -name "nessuscli" 2>/dev/null | grep -i "nessus.*agent" | head -n 1)
            if [ -n "$found_path" ]; then
                echo "$found_path"
                return 0
            fi
        fi
    done
    
    return 1
}

# Function to check if script is running with sudo/root
check_root() {
    if [ "$(id -u)" != "0" ]; then
        echo "Error: This script must be run with sudo or as root"
        exit 1
    fi
}

# Function to prompt for configuration
get_config() {
    # Use default values if provided as environment variables
    LINKING_KEY=${LINKING_KEY:-""}
    SERVER=${SERVER:-""}
    PORT=${PORT:-"8834"}
    
    # Prompt for linking key if not provided
    while [ -z "$LINKING_KEY" ]; do
        read -rp "Enter your Nessus Agent linking key: " LINKING_KEY
        if [ -z "$LINKING_KEY" ]; then
            echo "Linking key cannot be empty. Please try again."
        fi
    done
    
    # Prompt for server if not provided
    while [ -z "$SERVER" ]; do
        read -rp "Enter your Nessus server address [default: localhost]: " SERVER
        SERVER=${SERVER:-"localhost"}
    done
    
    # Prompt for port if not default
    read -rp "Enter your Nessus server port [default: 8834]: " PORT_INPUT
    PORT=${PORT_INPUT:-"8834"}
    
    # Validate port number
    if ! [[ "$PORT" =~ ^[0-9]+$ ]] || [ "$PORT" -lt 1 ] || [ "$PORT" -gt 65535 ]; then
        echo "Error: Invalid port number. Must be between 1 and 65535."
        exit 1
    fi
    
    # Display configuration for confirmation
    echo -e "\nConfiguration Summary:"
    echo "Server: $SERVER"
    echo "Port: $PORT"
    echo "Linking Key: ${LINKING_KEY:0:8}..." # Show only first 8 characters for security
    
    read -rp "Is this correct? (y/n): " CONFIRM
    if [[ ! $CONFIRM =~ ^[Yy] ]]; then
        echo "Configuration cancelled. Please run the script again."
        exit 1
    fi
}

# Main script
main() {
    # Check for root privileges
    check_root
    
    echo "Searching for Nessus Agent installation..."
    NESSUSCLI=$(find_nessus_agent)
    
    if [ $? -ne 0 ] || [ -z "$NESSUSCLI" ]; then
        echo "Error: Could not find Nessus Agent installation"
        echo "Please ensure Nessus Agent is installed in one of these locations:"
        echo "  - /opt/nessus_agent/sbin/nessuscli"
        echo "  - /Library/NessusAgent/run/sbin/nessuscli"
        exit 1
    fi
    
    echo "Found Nessus Agent at: $NESSUSCLI"
    
    # Verify nessuscli is executable
    if [ ! -x "$NESSUSCLI" ]; then
        echo "Error: $NESSUSCLI is not executable"
        exit 1
    fi
    
    # Get configuration from user
    get_config
    
    # Unlink existing agent if already linked
    echo "Checking current agent status..."
    if "$NESSUSCLI" agent status | grep -q "linked"; then
        echo "Unlinking existing agent configuration..."
        "$NESSUSCLI" agent unlink
    fi
    
    # Link the agent
    echo "Linking agent to server..."
    if ! "$NESSUSCLI" agent link --key="$LINKING_KEY" --host="$SERVER" --port="$PORT"; then
        echo "Error: Failed to link Nessus Agent"
        exit 1
    fi
    
    echo "Successfully linked Nessus Agent"
    echo "Current agent status:"
    "$NESSUSCLI" agent status
}

# Run main function
main
